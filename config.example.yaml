# All relative paths are resolved from this config file's directory.
# Default home setup uses ~/.bitdoze-bot/config.yml.

model:
    provider: openai_like
    id: stepfun/step-3.5-flash:free
    base_url: https://openrouter.ai/api/v1
    api_key_env: OPENAI_API_KEY
    structured_outputs: false

discord:
    token_env: DISCORD_BOT_TOKEN

runtime:
    agent_timeout: 600 # seconds, max time for a single agent.run (Discord messages, research)
    cron_timeout: 600 # seconds, max time for a cron job agent.run
    heartbeat_timeout: 120 # seconds, max time for a heartbeat agent.run
    max_concurrent_runs: 4 # max parallel agent.run calls
    slow_run_threshold_seconds: 45 # send a "still working" message if a run exceeds this, 0 disables
    streaming_enabled: true # stream responses to Discord (edit message as content arrives)
    streaming_edit_interval: 1.5 # seconds between Discord message edits during streaming

monitoring:
    telemetry_enabled: true
    telemetry_path: logs/run-telemetry.jsonl
    watchdog_enabled: true # heartbeat reports active runs older than threshold
    watchdog_threshold_seconds: 120
    watchdog_max_reports: 5

tool_fallback:
    denied_tools: [shell, discord] # fallback parser-executed tools to block by name

logging:
    level: INFO # DEBUG | INFO | WARNING | ERROR | CRITICAL
    format: detailed # detailed | simple | custom format string
    file:
        enabled: true
        path: logs/bitdoze-bot.log
        max_bytes: 10485760 # 10MB
        backup_count: 5

research_mode:
    enabled: true
    trigger_on_prefix: true # activates for messages that start with "research:"
    trigger_on_research_agent: true # activates when routed target is the research agent
    research_agent_name: research
    min_sources: 3 # minimum unique http(s) URLs in Sources

tool_permissions:
    enabled: true
    default_effect: deny # allow | deny (applies when no rule matches)
    rules: []
    # rules:
    #   - effect: deny
    #     tools: [shell]
    #   - effect: allow
    #     tools: [shell]
    #     role_ids: [123456789012345678]
    #     channel_ids: [234567890123456789]
    #   - effect: deny
    #     tools: [github]
    #     user_ids: [345678901234567890]
    #     guild_ids: [456789012345678901]
    #     agents: [research]
    audit:
        enabled: true
        path: logs/tool-audit.jsonl
        include_arguments: false # set true to record args/kwargs
        redacted_keys: [token, secret, password, api_key, authorization]

memory:
    mode: automatic
    db_file: data/bitdoze.db
    add_history_to_context: true
    num_history_runs: 5
    read_chat_history: true
    search_session_history: true
    num_history_sessions: 3
    add_memories_to_context: true
    enable_session_summaries: true
    add_session_summary_to_context: true
    summary_prompt: |
        You are generating a session summary. Return ONLY a JSON object.
        Required keys:
          - summary: string (required, must be present)
          - topics: array of strings (optional)
          - decisions: array of strings — key decisions made (optional)
          - unresolved: array of strings — open questions (optional)
        Use lowercase keys exactly as shown. Do not add extra keys or prose.
    summary_request_message: "Return JSON only. Include the required key: summary."

knowledge:
    enabled: false # set to true after running setup_knowledge.py
    backend: lancedb # lancedb (file-based, no docker) or pgvector (requires PostgreSQL)
    embedder: text-embedding-3-small
    # LanceDb settings (used when backend=lancedb)
    lance_uri: data/lancedb
    table_name: bitdoze_knowledge
    learnings_table_name: bitdoze_learnings
    # PgVector settings (used when backend=pgvector)
    db_url: null # or set PGVECTOR_DB_URL env var; e.g. postgresql+psycopg://bitdoze:bitdoze_secret@localhost:5532/bitdoze

learning:
    enabled: true
    mode: always # always | agentic | propose | hitl
    add_to_context: true
    stores:
        user_profile: true
        user_memory: true
        session_context: always
        entity_memory: false
        learned_knowledge: agentic # agent decides when to save/search learnings
        decision_log: false

toolkits:
    web_search:
        enabled: true
        backend: duckduckgo
    hackernews:
        enabled: true
    website:
        enabled: true
    github:
        enabled: true
        token_env: GITHUB_ACCESS_TOKEN
        base_url: null
    youtube:
        enabled: true
        languages: [en]
    file:
        enabled: true
        base_dir: workspace
    shell:
        enabled: false
        base_dir: workspace
    reddit:
        enabled: false
        client_id_env: REDDIT_CLIENT_ID
        client_secret_env: REDDIT_CLIENT_SECRET
        username_env: REDDIT_USERNAME
        password_env: REDDIT_PASSWORD
        user_agent: null
    discord:
        enabled: true

heartbeat:
    enabled: true
    interval_minutes: 30
    quiet_ack: HEARTBEAT_OK
    prompt_path: workspace/HEARTBEAT.md
    session_scope: isolated # isolated | shared
    agent: heartbeat # optional: run heartbeat with a dedicated low-context agent
    channel_id: null

cron:
    path: workspace/CRON.yaml

soul:
    path: workspace/SOUL.md

context:
    add_datetime: true
    timezone_identifier: Europe/Bucharest
    use_workspace_context_files: true
    agents_path: workspace/AGENTS.md
    user_path: workspace/USER.md
    memory_dir: workspace/memory
    long_memory_path: workspace/MEMORY.md
    main_session_scope: dm_only

agents:
    base_instructions: |
        You may be orchestrated inside teams. Delegate planning-heavy tasks to architect and
        implementation-heavy tasks to software-engineer when appropriate.
    workspace_dir: workspace/agents
    aliases:
        engineer: software-engineer
        software-enginner: software-engineer
    default: main
    definitions:
        - name: main
          tools:
              [
                  web_search,
                  hackernews,
                  website,
                  github,
                  youtube,
                  file,
                  shell,
                  discord,
                  discoveries,
              ]
          skills: []
          instructions: ""
        - name: research
          tools: [web_search, hackernews, website, github, youtube, file, shell, discoveries]
          skills: [web-research]
          instructions: ""
        - name: heartbeat
          tools: []
          skills: []
          memory:
              mode: disabled
              add_history_to_context: false
              read_chat_history: false
              search_session_history: false
              num_history_sessions: 0
              add_memories_to_context: false
              enable_session_summaries: false
              add_session_summary_to_context: false
          learning:
              enabled: false
          instructions: |
              You are a lightweight heartbeat monitor.
              Never call tools for heartbeat checks.
              If there is nothing to report, respond exactly: HEARTBEAT_OK
              If there is something to report, respond in 1-3 short bullets.
    routing:
        rules:
            - agent: delivery-team
              channel_ids: []
              user_ids: []
              guild_ids: []
              contains: ["manage", "orchestrate", "team:"]
              starts_with: ["team:"]
            - agent: research
              channel_ids: []
              user_ids: []
              guild_ids: []
              contains: ["research:"]
              starts_with: ["research:"]

teams:
    definitions:
        - name: delivery-team
          members: [architect, software-engineer]
          respond_directly: true
          determine_input_for_members: true
          delegate_to_all_members: false
          add_member_tools_to_context: true
          add_team_history_to_members: true
          num_team_history_runs: 5
          show_members_responses: false
          debug_mode: false
          instructions: |
              You are the delivery team coordinator.
              Produce one final answer after collecting architecture and implementation input.
              Keep output concise, actionable, and include next steps.

skills:
    enabled: true
    directories: [skills]
